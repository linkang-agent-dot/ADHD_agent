---
name: schedule-audit
description: 节日排期审核对比工具。对比排期审核表(xlsx)与正式上线表(csv)，进行三维审核：活动条目匹配、上线时间对比、服务器配置对比。自动生成审核总结报告(markdown)。当用户提到"排期审核"、"排期对比"、"上线审核"、"schedule audit"、"排期表 vs 上线表"时使用。
---

# 节日排期审核对比工具

对比排期审核表(xlsx)与正式上线表(csv)，输出三维审核报告。

## 输入要求

用户需提供两个文件路径：
1. **排期审核表** (.xlsx) — 内部排期计划
2. **正式上线表** (.csv, gbk编码) — 实际上线配置

## 工作流程

```
Task Progress:
- [ ] Step 1: 读取两份文件，提取数据
- [ ] Step 2: 构建活动名称映射
- [ ] Step 3: 运行审核脚本
- [ ] Step 4: 生成总结报告
```

### Step 1: 读取文件

运行审核脚本前，先用 Python 读取两个文件确认结构：

```python
# xlsx: 用 pandas + openpyxl, header=None
df = pd.read_excel(xlsx_path, engine='openpyxl', header=None)

# csv: 用 gbk 编码
df_csv = pd.read_csv(csv_path, encoding='gbk')
```

**Excel 表头结构（固定）：**
- 行0: 列名 (节日活动名/负责人/检查/跨服/上线/服务器数/互测check/互测负责人/活动条数/... /日期列)
- 行1: 日编号 (1,2,3,...) → 从列11开始
- 行2: 星期几 (周二,周三,...) → 从列11开始
- 行3: Excel日期序列号 (46063,...) → `datetime(1899,12,30) + timedelta(days=serial)`
- 行4+: 活动数据

**Excel 列含义：**
| 列索引 | 含义 |
|--------|------|
| 0 | 节日活动名 |
| 1 | 活动上线负责人 |
| 2 | 检查 |
| 3 | 跨服类型 (单服/跨服-全服/跨服-分组) |
| 4 | 上线 |
| 5 | 上线总服务器数量 |
| 6 | 互测check |
| 7 | 互测负责人 |
| 8 | 活动条数 |
| 9-10 | 其他 |
| 11-33 | 日期列(每列一天) |

**CSV 列含义：**
| 列索引 | 含义 |
|--------|------|
| 0 | 活动 ID |
| 1 | 活动名称 |
| 2 | 服务器（组） |
| 3 | 是否跨服排名 |
| 4 | 是否跨服 |
| 5 | 活动开始时间 |
| 6 | 活动结束时间 |
| 7 | 持续时长(h) |

### Step 2: 构建活动名称映射

排期表用简称，上线表用全称，需构建 `mapping: dict[str, list[str]]`。

**方法：**
1. 先列出双方所有活动名
2. 直接包含匹配 + 关键词模糊匹配
3. 查阅 [business_rules.md](business_rules.md) 中的别名规则
4. Agent 根据语义理解补充未自动匹配的项

**输出格式示例：**
```python
mapping = {
    '排期表活动名A': ['上线表活动名1', '上线表活动名2'],
    '排期表活动名B': ['上线表活动名3'],
    '排期表活动名C': [],  # 上线表缺失
}
```

### Step 3: 运行审核脚本

读取 `scripts/schedule_audit.py` 并根据当前节日的实际情况修改配置后运行：

```bash
python scripts/schedule_audit.py --xlsx <排期表路径> --csv <上线表路径> --mapping <mapping_json路径> --output <输出目录>
```

脚本执行三项审核：
1. **活动条目匹配** — 哪些匹配、哪些缺失
2. **上线时间对比** — 排期标记日 vs 实际上线日（+1天部署日规律）
3. **服务器配置对比** — 跨服类型/服务器数量/Schema分割

### Step 4: 生成总结报告

基于脚本输出，生成 markdown 总结报告，包含：

1. **总览** — 双方数据概况
2. **活动条目匹配** — 匹配/缺失清单
3. **上线时间对比** — 逐期比对（有标记的活动）+ 无标记活动列表
4. **服务器配置对比** — 跨服类型/服务器数量/Schema分割
5. **活动命名问题** — 检查是否沿用旧节日名称
6. **待确认事项清单** — 按优先级排列

## 业务规则

完整规则见 [business_rules.md](business_rules.md)，核心要点：

- **排期标记日 = 部署日**，实际上线 = 标记日 +1 天
- **"不灰"活动** → 全服含灰度 = 142 服务器（正确行为，不报错）
- **普通活动** → 全服标准 = 130 服务器
- **Schema 拆分**：S6(77) + S3-5(53) = 130（标准全服）
- **合成小游戏 = 挖矿**（同一活动的不同叫法）
- 上线表名称可能沿用旧节日名（如"圣诞节-bingo"），需检查并提示
