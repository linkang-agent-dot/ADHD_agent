# Git 配置变更检查功能 - 实现计划

## 一、功能概述

检查 Git 仓库（`C:\gdconfig\`）中分支的提交记录，分析 `fo` 目录下的文件变更，识别出需要检查修改的配置表。

---

## 二、核心流程

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  获取分支信息    │ ──▶ │  获取提交记录    │ ──▶ │  筛选变更文件    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                        │
                                                        ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  输出检查报告    │ ◀── │  分析表名/变更   │ ◀── │  过滤fo目录文件  │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

---

## 三、详细实现步骤

### 步骤 1：初始化 Git 仓库连接

**目标**：连接到本地 Git 仓库

**具体操作**：
1. 指定仓库路径：`C:\gdconfig\`
2. 验证该路径是否为有效的 Git 仓库
3. 获取仓库对象用于后续操作

**技术方案**：
- 使用 `gitpython` 库的 `git.Repo()` 方法
- 或使用命令行 `git -C C:\gdconfig\ status` 验证

---

### 步骤 2：获取分支信息

**目标**：确定要检查的分支

**具体操作**：
1. 获取当前活动分支名称
2. （可选）列出所有可用分支供用户选择
3. 确定比较的基准分支（通常是 `main` 或 `master`）

**关键命令**：
```bash
# 获取当前分支
git -C C:\gdconfig\ branch --show-current

# 列出所有分支
git -C C:\gdconfig\ branch -a
```

---

### 步骤 3：获取提交记录

**目标**：获取分支上的提交历史

**具体操作**：
1. 确定时间范围或提交范围
   - 方案A：指定时间范围（如最近7天）
   - 方案B：指定提交数量（如最近10次提交）
   - 方案C：两个分支之间的差异（如 `main..feature-branch`）
2. 获取每个提交的基本信息：
   - 提交哈希（commit hash）
   - 提交时间
   - 提交作者
   - 提交信息

**关键命令**：
```bash
# 获取分支与main的差异提交
git -C C:\gdconfig\ log main..HEAD --oneline

# 获取最近N次提交
git -C C:\gdconfig\ log -n 10 --oneline

# 获取详细提交信息
git -C C:\gdconfig\ log --format="%H|%ai|%an|%s" main..HEAD
```

---

### 步骤 4：获取每个提交的变更文件列表

**目标**：识别每个提交中修改了哪些文件

**具体操作**：
1. 遍历步骤3获取的每个提交
2. 获取该提交涉及的所有变更文件
3. 记录变更类型：
   - `A` - 新增文件
   - `M` - 修改文件
   - `D` - 删除文件
   - `R` - 重命名文件

**关键命令**：
```bash
# 获取两个提交之间的变更文件
git -C C:\gdconfig\ diff --name-status main..HEAD

# 获取单个提交的变更文件
git -C C:\gdconfig\ show --name-status --format="" <commit-hash>
```

---

### 步骤 5：过滤 `fo` 目录下的文件

**目标**：只保留 `fo` 目录下的变更文件

**具体操作**：
1. 从步骤4的结果中筛选路径以 `fo/` 开头的文件
2. 排除非目标目录的变更
3. 保留完整的文件路径信息

**过滤规则**：
```
保留: fo/table_a.csv
保留: fo/subdir/table_b.json
排除: other_dir/config.yaml
排除: root_file.txt
```

**关键命令**：
```bash
# 直接获取fo目录下的变更
git -C C:\gdconfig\ diff --name-status main..HEAD -- fo/
```

---

### 步骤 6：分析变更内容，提取表名

**目标**：从变更文件中识别配置表名称

**具体操作**：
1. 解析文件名，提取表名
   - 假设文件名格式：`表名.扩展名` 或 `表名_版本.扩展名`
2. 对于每个变更文件，记录：
   - 表名
   - 文件完整路径
   - 变更类型（新增/修改/删除）
   - 关联的提交信息
3. 去重合并：同一个表可能在多次提交中被修改

**数据结构示例**：
```python
{
    "table_name": "user_config",
    "file_path": "fo/user_config.csv",
    "change_type": "M",  # Modified
    "commits": [
        {
            "hash": "abc123",
            "message": "更新用户配置",
            "author": "developer",
            "time": "2026-02-01 10:00:00"
        }
    ]
}
```

---

### 步骤 7：（可选）获取具体变更内容

**目标**：获取文件的详细变更差异

**具体操作**：
1. 对于每个变更文件，获取 diff 内容
2. 解析新增/删除/修改的行
3. 标记具体变更的字段或记录

**关键命令**：
```bash
# 获取文件的详细diff
git -C C:\gdconfig\ diff main..HEAD -- fo/specific_file.csv
```

---

### 步骤 8：生成检查报告

**目标**：汇总所有信息，生成可读的报告

**报告内容**：
1. **摘要信息**
   - 检查时间
   - 分支名称
   - 提交范围
   - 变更文件总数
   - 涉及表的数量

2. **变更表清单**
   - 按变更类型分组（新增/修改/删除）
   - 每个表的详细信息

3. **详细变更记录**
   - 按提交时间排序
   - 每个提交涉及的表

**输出格式选项**：
- 控制台文本输出
- Markdown 文件
- JSON 结构化数据

---

## 四、配置参数

| 参数名 | 说明 | 默认值 |
|--------|------|--------|
| `repo_path` | Git 仓库路径 | `C:\gdconfig\` |
| `target_dir` | 目标检查目录 | `fo/` |
| `base_branch` | 基准分支 | `main` |
| `compare_branch` | 比较分支 | 当前分支 |
| `commit_range` | 提交范围 | `main..HEAD` |

---

## 五、输出示例

```
=====================================
Git 配置变更检查报告
=====================================
检查时间: 2026-02-02 14:30:00
仓库路径: C:\gdconfig\
检查目录: fo/
分支: feature/update-config
比较基准: main
提交数量: 3

-------------------------------------
变更表汇总 (共 5 个表)
-------------------------------------

【新增】(1个)
  - new_feature_config (fo/new_feature_config.csv)

【修改】(3个)
  - user_config (fo/user_config.csv)
  - item_config (fo/item_config.json)
  - level_config (fo/level_config.csv)

【删除】(1个)
  - deprecated_config (fo/deprecated_config.csv)

-------------------------------------
详细提交记录
-------------------------------------

[1] abc1234 - 2026-02-01 10:00 - developer
    消息: 添加新功能配置
    变更: + fo/new_feature_config.csv
          M fo/user_config.csv

[2] def5678 - 2026-02-01 14:00 - developer
    消息: 更新道具配置
    变更: M fo/item_config.json
          M fo/level_config.csv

[3] ghi9012 - 2026-02-02 09:00 - developer
    消息: 移除废弃配置
    变更: - fo/deprecated_config.csv

=====================================
```

---

## 六、技术依赖

| 依赖 | 用途 | 安装方式 |
|------|------|----------|
| `gitpython` | Python Git 操作库 | `pip install gitpython` |
| 或 `subprocess` | 调用 git 命令行 | Python 内置 |

---

## 七、扩展功能（后续可选）

1. **自动化集成**
   - 集成到 CI/CD 流程
   - 定时检查并发送通知

2. **变更对比详情**
   - 显示具体变更的行内容
   - 支持表格数据的字段级对比

3. **检查规则配置**
   - 支持配置忽略某些文件/表
   - 支持配置关注特定类型的变更

4. **多仓库支持**
   - 同时检查多个配置仓库
   - 汇总多仓库的变更报告
